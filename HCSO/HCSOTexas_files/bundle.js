webpackJsonp(["bundle.NetworkInstrument"],{"27oY":function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r("Dd8w"),i=r.n(n),o=r("+6Bu"),s=r.n(o),a=r("Zrlr"),u=r.n(a),_=r("wxAW"),d=r.n(_),p=r("d39v"),c=r("nb4O"),f=r.n(c),m=r("Y/fN"),h=r.n(m),l=r("iJOc"),v=r.n(l),w=[p.a.BadOauthToken,p.a.OauthTimestampException,p.a.BadAuthenticationData,p.a.AccessDeniedByBouncer],y=function(){function e(t,r){var n=this;u()(this,e),this.scribeRequest=function(e){var t=e.response,r=e.error,i=s()(e,["response","error"]),o=n._fixGraphQLPathIfNeeded(i),a=new window.URL(o.url);if(t.status&&0!==a.pathname.indexOf("/1.1/jot")){n._flushResourceTimingBuffer();var u=h()(n._buffer,function(e){var t=e.request;return a.protocol===t.uri_scheme&&a.hostname===t.uri_host_name&&a.pathname===t.uri_path&&(a.query||"")===t.uri_query});if(u){var _=n._buffer.indexOf(u);n._buffer[_]=n._updateEventWithRequestResponse(u,o,t,r)}else{var d=n._updateEventWithRequestResponse(n._prepareEvent(o.url),o,t,r);n._buffer.push(d)}n._flushBuffer()}},this._flushResourceTimingBuffer=function(){if(n._resourceTimingApiSupported){var e=window.performance.getEntriesByType("resource");window.performance.clearResourceTimings(),e.forEach(function(e){var t=n._updateEventWithPrecisionTimings(n._prepareEvent(e.name),e);n._buffer.push(t)})}},this._updateNetworkInfo=function(e){var t=e.target?e.target:e;n._networkInfo=t},this._getNetworkMeasurements=function(){return{connection_type:n._networkInfo.type,speed_class:n._networkInfo.effectiveType,download_mbps:n._networkInfo.downlink,download_max_mbps:n._networkInfo.downlinkMax,rtt_ms:n._networkInfo.rtt,reduced_data_usage:n._networkInfo.saveData}},this._resourceTimingApiSupported=window.performance&&window.performance.getEntriesByType&&window.performance.getEntriesByType("resource")&&window.performance.clearResourceTimings,this._scribe=t,this._options=i()({apiErrorSampleSize:0,apiSampleSize:0,cdnSampleSize:0,cdnHostList:[]},r),this._buffer=[],this._networkInfo={},v.a.getConnectionInfo().then(function(e){n._updateNetworkInfo(e),v.a.addEventListener("connectionChange",n._updateNetworkInfo)}),this._resourceTimingApiSupported&&(window.performance.onresourcetimingbufferfull=this._flushResourceTimingBuffer)}return d()(e,[{key:"_flushBuffer",value:function(){var e=this;this._buffer.splice(0,this._buffer.length).forEach(function(t){e._sample(t)&&e._scribe.log(null,t)})}},{key:"_sample",value:function(e){var t=e.event_type,r={"api:all":"apiSampleSize","api:error":"apiErrorSampleSize","cdn:all":"cdnSampleSize"},n=this._options[r[t]]||0;return Math.random()<n}},{key:"_getEventType",value:function(e,t){return this._options.cdnHostList.indexOf(e)>-1?"cdn:all":200===t?"api:all":"api:error"}},{key:"_fixGraphQLPathIfNeeded",value:function(e){if("https://api.twitter.com/graphql"===e.url&&"POST"===e.method&&e.data){var t=JSON.parse(e.data),r=t&&t.queryId;if(r)return i()({},e,{url:"https://api.twitter.com/graphql/"+r})}return e}},{key:"_prepareEvent",value:function(e){var t=new window.URL(e),r="api.twitter.com"===t.hostname;return{_category_:"client_network_request_event",request:{uri_scheme:t.protocol,uri_host_name:t.hostname,uri_path:t.pathname,uri_query:t.query||"",http_method:r?void 0:"GET",http_status_code:r?0:200,start_time_ms:Date.now(),request_details:{}},common_header:{commonHeader:{clientHeader:{timestampMs:Date.now(),timezoneOffsetMin:-(new Date).getTimezoneOffset()}}},network_measurements:this._getNetworkMeasurements(),event_type:this._getEventType(t.hostname,200),event_source:"rweb"}}},{key:"_extractApiErrorCode",value:function(e){var t=e.errors,r=void 0===t?[]:t,n=r.map(function(e){return e.code}).filter(function(e){return void 0!==e}),i=f()(n,function(e){return w.indexOf(e)>-1});return i||(n.length>0?n[0]:void 0)}},{key:"_updateEventWithRequestResponse",value:function(e,t,r,n){var o=e.request.request_details;return i()({},e,{request:i()({},e.request,{http_method:t.method,http_status_code:r.status,start_time_ms:t.startTimestamp,trace_id:t.headers["x-b3-traceid"],twitter_api_error_code:n&&this._extractApiErrorCode(n)||void 0,request_details:i()({},o,{duration_ms:o.duration_ms||t.endTimestamp-t.startTimestamp,request_body_size:o.request_body_size||t.data&&t.data.length,response_body_size:o.response_body_size||r&&r.body&&r.body.length})}),event_type:this._getEventType(e.request.uri_host_name,r.status)})}},{key:"_getTiming",value:function(e,t){var r=t+"Start",n=t+"End",i=e[r],o=e[n]||0;return 0===i&&0===o?void 0:Math.round(o-i)}},{key:"_updateEventWithPrecisionTimings",value:function(e,t){return i()({},e,{request:i()({},e.request,{request_details:i()({},e.request.request_details,{duration_ms:Math.round(t.responseEnd-t.fetchStart),rx_bytes:t.transferSize,dns_ms:this._getTiming(t,"domainLookup"),tcp_ms:this._getTiming(t,"connect"),tls_ms:0===t.secureConnectionStart?void 0:Math.round(t.connectEnd-t.secureConnectionStart),response_body_size:t.decodedBodySize})})})}}]),e}();t.default=y}});